<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Classroom API Tool</title>
    <!-- Load the Google API client library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Load the Google Identity Services library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Include the Google OAuth library -->
    <script src="https://accounts.google.com/gsi/client" onload="initTokenClient()"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .header {
            background-color: #4285f4;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 54px);
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .class-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .class-item:hover {
            background-color: #f5f5f5;
        }
        
        .class-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .class-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .class-option {
            font-size: 13px;
            color: #4285f4;
            cursor: pointer;
        }
        
        .class-option:hover {
            text-decoration: underline;
        }
        
        .selected {
            background-color: #e8f0fe;
            border-left: 4px solid #4285f4;
        }
        
        button {
            padding: 8px 12px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #3367d6;
        }
        
        .config-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .config-section input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #4285f4;
        }
        
        .error {
            background-color: #fce8e6;
            border-left: 4px solid #ea4335;
        }
        
        #loading {
            display: none;
            margin: 10px 0;
            color: #4285f4;
        }
        
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            max-height: 400px;
            font-size: 13px;
        }
        
        .data-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .data-card h2 {
            margin-top: 0;
            color: #4285f4;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background-color: #f5f5f5;
        }
        
        .refresh-button {
            background-color: transparent;
            color: #4285f4;
            border: 1px solid #4285f4;
            padding: 6px 12px;
            float: right;
            font-size: 12px;
        }
        
        .link-button {
            color: #4285f4;
            text-decoration: none;
            cursor: pointer;
        }
        
        #auth-section {
            margin: 20px 0;
        }
        
        #google-signin-button {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Google Classroom API Tool</h1>
    </div>
    
    <div class="content-area" id="setup-area">
        <div class="config-section">
            <h2 id="credentials-header">API Configuration</h2>
            <p id="credentials-info">Enter your Google API credentials:</p>
            <input type="text" id="client-id-input" placeholder="Enter your OAuth 2.0 Client ID" />
            <input type="text" id="api-key-input" placeholder="Enter your API Key" />
            <button id="save-credentials">Save & Initialize</button>
            
            <div style="margin-top: 15px; padding: 10px; background-color: #e8f0fe; border-left: 4px solid #1a73e8;">
                <h3 style="margin-top: 0;">Common Issues Troubleshooting</h3>
                <p><strong>"Not a valid origin for the client"</strong>: If you see this error, you need to add <code>http://localhost:9000</code> to the list of authorized JavaScript origins in your Google Cloud Console.</p>
                <p><strong>"idpiframe_initialization_failed"</strong>: This error occurs because of outdated OAuth libraries. The code has been updated to use only the newer Google Identity Services.</p>
            </div>
        </div>
        
        <div id="status-message" class="status"></div>
        <div id="loading">Loading data...</div>
        
        <div id="auth-section">
            <!-- Google Sign In button will be inserted here -->
            <div id="google-signin-button"></div>
            <button id="signout-button" style="display:none;">Sign Out</button>
        </div>
    </div>
    
    <div class="main-container" id="main-container" style="display:none;">
        <div class="sidebar" id="class-sidebar">
            <div style="padding: 15px;">
                <button id="refresh-classes" class="refresh-button">Refresh Classes</button>
                <h2>My Classes</h2>
            </div>
            <div id="classes-list">
                <!-- Classes will be listed here -->
                <div class="class-item">
                    <div class="class-loader">Loading classes...</div>
                </div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="data-card" id="welcome-card">
                <h2>Welcome to Google Classroom Tool</h2>
                <p>Select a class from the sidebar to view its details, students, or assignments.</p>
            </div>
            
            <div class="data-card" id="class-detail-card" style="display:none;">
                <h2 id="class-detail-title">Class Details</h2>
                <div id="class-detail-content"></div>
            </div>
            
            <div class="data-card" id="students-card" style="display:none;">
                <h2 id="students-title">Students</h2>
                <div id="students-content"></div>
            </div>
            
            <div class="data-card" id="assignments-card" style="display:none;">
                <h2 id="assignments-title">Assignments</h2>
                <div id="assignments-content"></div>
            </div>
            
            <div class="data-card" id="submissions-card" style="display:none;">
                <h2 id="submissions-title">Assignment Submissions</h2>
                <div>
                    <p id="submission-instruction">Select an assignment to view submissions</p>
                    <div id="assignment-selector" style="display:none;">
                        <select id="coursework-select">
                            <option value="">Select Assignment</option>
                        </select>
                        <button id="view-submissions">View Submissions</button>
                    </div>
                </div>
                <div id="submissions-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Cache DOM elements
        const setupArea = document.getElementById('setup-area');
        const mainContainer = document.getElementById('main-container');
        const classesList = document.getElementById('classes-list');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading');
        const signoutButton = document.getElementById('signout-button');
        const saveCredentialsButton = document.getElementById('save-credentials');
        const clientIdInput = document.getElementById('client-id-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const refreshClassesButton = document.getElementById('refresh-classes');
        
        // Content cards
        const welcomeCard = document.getElementById('welcome-card');
        const classDetailCard = document.getElementById('class-detail-card');
        const studentsCard = document.getElementById('students-card');
        const assignmentsCard = document.getElementById('assignments-card');
        const submissionsCard = document.getElementById('submissions-card');
        
        // Credentials will be fetched from server
        let CLIENT_ID = '';
        let API_KEY = '';
        
        // Store classes data
        let classesData = [];
        let currentClassId = null;
        
        // Define the API scopes
        const SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly ' +
                       'https://www.googleapis.com/auth/classroom.rosters.readonly ' +
                       'https://www.googleapis.com/auth/classroom.coursework.me ' +
                       'https://www.googleapis.com/auth/classroom.coursework.students.readonly ' +
                       'https://www.googleapis.com/auth/classroom.student-submissions.me.readonly ' +
                       'https://www.googleapis.com/auth/classroom.student-submissions.students.readonly';
        
        // Token client for OAuth 2.0 flow
        let tokenClient;
        
        // Access token storage
        let currentAccessToken = null;
        let isAuthenticated = false;
        
        // Initialize token client
        function initTokenClient() {
            // Will be initialized after credentials are saved
        }
        
        // Fetch credentials from server and initialize
        window.onload = function() {
            // Hide credentials input fields as they're no longer needed
            clientIdInput.style.display = 'none';
            apiKeyInput.style.display = 'none';
            document.getElementById('credentials-header').textContent = 'Secure API Configuration';
            document.getElementById('credentials-info').textContent = 'API credentials are securely loaded from the server.';
            
            // Fetch credentials from server
            fetchCredentials();
            
            // Setup event listeners
            saveCredentialsButton.addEventListener('click', saveCredentials);
            signoutButton.addEventListener('click', handleSignOut);
            refreshClassesButton.addEventListener('click', fetchClasses);
            document.getElementById('view-submissions').addEventListener('click', viewSelectedSubmissions);
        };
        
        // Fetch credentials from server
        async function fetchCredentials() {
            try {
                showMessage('Fetching secure credentials from server...');
                const response = await fetch('/api/credentials');
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                CLIENT_ID = data.CLIENT_ID;
                API_KEY = data.API_KEY;
                showMessage('Credentials securely loaded. Click \'Save & Initialize\' to proceed.');
                saveCredentialsButton.textContent = 'Initialize API';
            } catch (error) {
                console.error('Error fetching credentials:', error);
                showMessage('Failed to load credentials from server: ' + error.message, true);
            }
        }
        
        // Initialize API with secure credentials
        function saveCredentials() {
            if (!CLIENT_ID || !API_KEY) {
                showMessage("Credentials not loaded properly. Please refresh the page.", true);
                return;
            }
            
            showMessage("Using secure credentials. Initializing Google API...");
            
            // Initialize the Google API client
            initializeGoogleApiClient();
        }
        
        // Show a status message to the user
        function showMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? "status error" : "status";
            console.log(message);
        }
        
        // Show/hide loading indicator
        function setLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
        }
        
        // Initialize the Google API client
        async function initializeGoogleApiClient() {
            setLoading(true);
            showMessage("Loading Google API Client...");
            
            try {
                // Initialize the gapi.client with API key and discovery docs
                await gapi.load('client', async () => {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ["https://classroom.googleapis.com/$discovery/rest?version=v1"]
                    });
                    
                    showMessage("API client loaded. Initializing authentication...");
                    initializeGoogleAuth();
                });
            } catch (error) {
                setLoading(false);
                console.error("Error initializing the API client", error);
                showMessage("Error initializing the API client: " + (error.message || JSON.stringify(error)), true);
            }
        }
        
        // Initialize Google Authentication
        function initializeGoogleAuth() {
            // Initialize the token client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        // Store the access token
                        currentAccessToken = tokenResponse.access_token;
                        isAuthenticated = true;
                        
                        // Configure API calls with the token
                        gapi.client.setToken(tokenResponse);
                        
                        // Update UI
                        updateUIForSignIn(true);
                        showMessage("Authentication successful.");
                        setLoading(false);
                        
                        // Fetch classes automatically after signing in
                        fetchClasses();
                    }
                },
                error_callback: (error) => {
                    console.error("Error getting access token", error);
                    showMessage("Authentication failed: " + error.message, true);
                    setLoading(false);
                }
            });
            
            // Display sign-in button
            setupSignInButton();
            setLoading(false);
        }
        
        // Set up Google Sign-In button
        function setupSignInButton() {
            const googleSignInButton = document.getElementById('google-signin-button');
            googleSignInButton.innerHTML = '';
            
            // Create custom sign-in button
            const signInBtn = document.createElement('button');
            signInBtn.textContent = 'Sign in with Google';
            signInBtn.className = 'signin-button';
            signInBtn.addEventListener('click', () => {
                setLoading(true);
                showMessage("Requesting access token...");
                
                // Request an access token
                tokenClient.requestAccessToken();
            });
            
            googleSignInButton.appendChild(signInBtn);
        }
        
        // Update UI based on sign-in status
        function updateUIForSignIn(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('google-signin-button').style.display = 'none';
                signoutButton.style.display = 'inline-block';
                setupArea.style.display = 'none';
                mainContainer.style.display = 'flex';
            } else {
                document.getElementById('google-signin-button').style.display = 'block';
                signoutButton.style.display = 'none';
                setupArea.style.display = 'block';
                mainContainer.style.display = 'none';
                currentAccessToken = null;
                isAuthenticated = false;
                
                // Clear API token
                gapi.client.setToken(null);
            }
        }
        
        // Handle sign-out
        function handleSignOut() {
            // Remove token and update UI
            google.accounts.oauth2.revoke(currentAccessToken, () => {
                updateUIForSignIn(false);
                showMessage("Signed out successfully.");
            });
        }
        
        // Check authentication before making API calls
        function checkAuthentication() {
            if (!isAuthenticated) {
                showMessage("You need to sign in first", true);
                return false;
            }
            return true;
        }
        
        // Fetch classes and populate sidebar
        async function fetchClasses() {
            if (!checkAuthentication()) return;
            
            setLoading(true);
            classesList.innerHTML = '<div class="class-item"><div class="class-loader">Loading classes...</div></div>';
            
            try {
                const response = await gapi.client.classroom.courses.list({
                    pageSize: 50
                });
                
                const classes = response.result.courses || [];
                classesData = classes;
                
                // Clear and populate the classes list
                classesList.innerHTML = '';
                
                if (classes.length === 0) {
                    classesList.innerHTML = '<div class="class-item">No classes found</div>';
                } else {
                    classes.forEach(course => {
                        const classItem = document.createElement('div');
                        classItem.className = 'class-item';
                        classItem.dataset.id = course.id;
                        
                        const className = document.createElement('div');
                        className.className = 'class-name';
                        className.textContent = course.name;
                        
                        const classOptions = document.createElement('div');
                        classOptions.className = 'class-options';
                        
                        const detailsOption = document.createElement('span');
                        detailsOption.className = 'class-option';
                        detailsOption.textContent = 'Details';
                        detailsOption.onclick = (e) => {
                            e.stopPropagation();
                            showClassDetails(course.id);
                        };
                        
                        const studentsOption = document.createElement('span');
                        studentsOption.className = 'class-option';
                        studentsOption.textContent = 'Students';
                        studentsOption.onclick = (e) => {
                            e.stopPropagation();
                            fetchStudents(course.id);
                        };
                        
                        const assignmentsOption = document.createElement('span');
                        assignmentsOption.className = 'class-option';
                        assignmentsOption.textContent = 'Assignments';
                        assignmentsOption.onclick = (e) => {
                            e.stopPropagation();
                            fetchAssignments(course.id);
                        };
                        
                        const submissionsOption = document.createElement('span');
                        submissionsOption.className = 'class-option';
                        submissionsOption.textContent = 'Submissions';
                        submissionsOption.onclick = (e) => {
                            e.stopPropagation();
                            prepareSubmissions(course.id);
                        };
                        
                        classOptions.appendChild(detailsOption);
                        classOptions.appendChild(studentsOption);
                        classOptions.appendChild(assignmentsOption);
                        classOptions.appendChild(submissionsOption);
                        
                        classItem.appendChild(className);
                        classItem.appendChild(classOptions);
                        
                        classItem.addEventListener('click', () => {
                            showClassDetails(course.id);
                        });
                        
                        classesList.appendChild(classItem);
                    });
                }
                
                showMessage(`Successfully loaded ${classes.length} classes`);
            } catch (error) {
                console.error("Error fetching classes:", error);
                let errorMsg = "Error fetching classes: ";
                
                if (error.result) {
                    errorMsg += error.result.error.message || JSON.stringify(error.result);
                } else if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += JSON.stringify(error);
                }
                
                classesList.innerHTML = `<div class="class-item error">${errorMsg}</div>`;
                showMessage(errorMsg, true);
            } finally {
                setLoading(false);
            }
        }
        
        // Show class details
        function showClassDetails(classId) {
            if (!checkAuthentication()) return;
            
            // Update selected class
            updateSelectedClass(classId);
            currentClassId = classId;
            
            // Find the class data
            const classData = classesData.find(c => c.id === classId);
            if (!classData) {
                showMessage(`Class with ID ${classId} not found.`, true);
                return;
            }
            
            // Hide other cards and show class detail card
            hideAllCards();
            classDetailCard.style.display = 'block';
            document.getElementById('class-detail-title').textContent = `Class: ${classData.name}`;
            
            // Create a formatted display of class details
            const detailsHtml = `
                <table class="data-table">
                    <tr><th>Class Name</th><td>${classData.name}</td></tr>
                    <tr><th>Section</th><td>${classData.section || 'N/A'}</td></tr>
                    <tr><th>Description</th><td>${classData.description || 'No description'}</td></tr>
                    <tr><th>Room</th><td>${classData.room || 'N/A'}</td></tr>
                    <tr><th>Class ID</th><td>${classData.id}</td></tr>
                    <tr><th>Course State</th><td>${classData.courseState || 'Active'}</td></tr>
                </table>
            `;
            
            document.getElementById('class-detail-content').innerHTML = detailsHtml;
        }
        
        // Fetch and show students for a class
        async function fetchStudents(classId) {
            if (!checkAuthentication()) return;
            
            // Update selected class
            updateSelectedClass(classId);
            currentClassId = classId;
            
            setLoading(true);
            
            // Find the class name
            const classData = classesData.find(c => c.id === classId);
            const className = classData ? classData.name : 'Unknown Class';
            
            // Set up the UI
            hideAllCards();
            studentsCard.style.display = 'block';
            document.getElementById('students-title').textContent = `Students: ${className}`;
            document.getElementById('students-content').innerHTML = '<p>Loading students...</p>';
            
            try {
                const response = await gapi.client.classroom.courses.students.list({
                    courseId: classId,
                    pageSize: 100
                });
                
                const students = response.result.students || [];
                
                if (students.length === 0) {
                    document.getElementById('students-content').innerHTML = '<p>No students found in this class.</p>';
                } else {
                    let tableHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Profile ID</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    students.forEach(student => {
                        tableHtml += `
                            <tr>
                                <td>${student.profile.name.fullName}</td>
                                <td>${student.profile.emailAddress}</td>
                                <td>${student.profile.id}</td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('students-content').innerHTML = tableHtml;
                }
                
                showMessage(`Successfully loaded ${students.length} students`);
            } catch (error) {
                console.error("Error fetching students:", error);
                let errorMsg = "Error fetching students: ";
                
                if (error.result) {
                    errorMsg += error.result.error.message || JSON.stringify(error.result);
                } else if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += JSON.stringify(error);
                }
                
                document.getElementById('students-content').innerHTML = `<p class="error">${errorMsg}</p>`;
                showMessage(errorMsg, true);
            } finally {
                setLoading(false);
            }
        }
        
        // Fetch and show assignments for a class
        async function fetchAssignments(classId) {
            if (!checkAuthentication()) return;
            
            // Update selected class
            updateSelectedClass(classId);
            currentClassId = classId;
            
            setLoading(true);
            
            // Find the class name
            const classData = classesData.find(c => c.id === classId);
            const className = classData ? classData.name : 'Unknown Class';
            
            // Set up the UI
            hideAllCards();
            assignmentsCard.style.display = 'block';
            document.getElementById('assignments-title').textContent = `Assignments: ${className}`;
            document.getElementById('assignments-content').innerHTML = '<p>Loading assignments...</p>';
            
            try {
                const response = await gapi.client.classroom.courses.courseWork.list({
                    courseId: classId,
                    pageSize: 100
                });
                
                const assignments = response.result.courseWork || [];
                
                if (assignments.length === 0) {
                    document.getElementById('assignments-content').innerHTML = '<p>No assignments found in this class.</p>';
                } else {
                    let tableHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Due Date</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    assignments.forEach(assignment => {
                        const dueDate = assignment.dueDate ? 
                            `${assignment.dueDate.month}/${assignment.dueDate.day}/${assignment.dueDate.year}` : 
                            'No due date';
                        
                        const createdDate = new Date(assignment.creationTime).toLocaleDateString();
                        
                        tableHtml += `
                            <tr>
                                <td>${assignment.title}</td>
                                <td>${assignment.workType || 'Assignment'}</td>
                                <td>${dueDate}</td>
                                <td>${createdDate}</td>
                                <td>
                                    <a class="link-button" onclick="fetchSubmissionsForAssignment('${classId}', '${assignment.id}')">View Submissions</a>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('assignments-content').innerHTML = tableHtml;
                    
                    // Add global function for the onclick handler
                    window.fetchSubmissionsForAssignment = function(classId, assignmentId) {
                        fetchSubmissions(classId, assignmentId);
                    };
                }
                
                showMessage(`Successfully loaded ${assignments.length} assignments`);
            } catch (error) {
                console.error("Error fetching assignments:", error);
                let errorMsg = "Error fetching assignments: ";
                
                if (error.result) {
                    errorMsg += error.result.error.message || JSON.stringify(error.result);
                } else if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += JSON.stringify(error);
                }
                
                document.getElementById('assignments-content').innerHTML = `<p class="error">${errorMsg}</p>`;
                showMessage(errorMsg, true);
            } finally {
                setLoading(false);
            }
        }
        
        // Prepare submissions view
        async function prepareSubmissions(classId) {
            if (!checkAuthentication()) return;
            
            // Update selected class
            updateSelectedClass(classId);
            currentClassId = classId;
            
            setLoading(true);
            
            // Find the class name
            const classData = classesData.find(c => c.id === classId);
            const className = classData ? classData.name : 'Unknown Class';
            
            // Set up the UI
            hideAllCards();
            submissionsCard.style.display = 'block';
            document.getElementById('submissions-title').textContent = `Submissions: ${className}`;
            document.getElementById('submission-instruction').style.display = 'block';
            document.getElementById('assignment-selector').style.display = 'flex';
            document.getElementById('submissions-content').innerHTML = '';
            
            try {
                const response = await gapi.client.classroom.courses.courseWork.list({
                    courseId: classId,
                    pageSize: 100
                });
                
                const assignments = response.result.courseWork || [];
                const selectElement = document.getElementById('coursework-select');
                
                // Clear previous options
                selectElement.innerHTML = '<option value="">Select Assignment</option>';
                
                if (assignments.length === 0) {
                    document.getElementById('submissions-content').innerHTML = '<p>No assignments found in this class.</p>';
                    document.getElementById('assignment-selector').style.display = 'none';
                } else {
                    assignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.id;
                        option.textContent = assignment.title;
                        selectElement.appendChild(option);
                    });
                }
                
                showMessage(`Select an assignment to view submissions`);
            } catch (error) {
                console.error("Error fetching assignments for submissions:", error);
                let errorMsg = "Error preparing submissions view: ";
                
                if (error.result) {
                    errorMsg += error.result.error.message || JSON.stringify(error.result);
                } else if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += JSON.stringify(error);
                }
                
                document.getElementById('submissions-content').innerHTML = `<p class="error">${errorMsg}</p>`;
                showMessage(errorMsg, true);
            } finally {
                setLoading(false);
            }
        }
        
        // View submissions for selected assignment
        function viewSelectedSubmissions() {
            const selectElement = document.getElementById('coursework-select');
            const assignmentId = selectElement.value;
            
            if (!assignmentId) {
                showMessage("Please select an assignment", true);
                return;
            }
            
            fetchSubmissions(currentClassId, assignmentId);
        }
        
        // Fetch and show submissions for an assignment
        async function fetchSubmissions(classId, assignmentId) {
            if (!checkAuthentication()) return;
            
            setLoading(true);
            
            // Hide the instruction and show that we're loading
            document.getElementById('submission-instruction').style.display = 'none';
            document.getElementById('submissions-content').innerHTML = '<p>Loading submissions...</p>';
            
            try {
                const response = await gapi.client.classroom.courses.courseWork.studentSubmissions.list({
                    courseId: classId,
                    courseWorkId: assignmentId
                });
                
                const submissions = response.result.studentSubmissions || [];
                
                if (submissions.length === 0) {
                    document.getElementById('submissions-content').innerHTML = '<p>No submissions found for this assignment.</p>';
                } else {
                    // First, fetch the assignment details for the title
                    const assignmentResponse = await gapi.client.classroom.courses.courseWork.get({
                        courseId: classId,
                        id: assignmentId
                    });
                    
                    const assignment = assignmentResponse.result;
                    
                    let submissionsHtml = `
                        <h3>Submissions for: ${assignment.title}</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Status</th>
                                    <th>Grade</th>
                                    <th>Submitted</th>
                                    <th>Attachments</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // We need to fetch student names
                    const studentsResponse = await gapi.client.classroom.courses.students.list({
                        courseId: classId
                    });
                    
                    const students = studentsResponse.result.students || [];
                    const studentsMap = {};
                    
                    students.forEach(student => {
                        studentsMap[student.userId] = student.profile.name.fullName;
                    });
                    
                    // Now add each submission
                    for (const submission of submissions) {
                        const studentName = studentsMap[submission.userId] || 'Unknown Student';
                        const submissionTime = submission.submissionTime ? 
                            new Date(submission.submissionTime).toLocaleString() : 'Not submitted';
                        
                        let attachmentLinks = 'No attachments';
                        
                        if (submission.assignmentSubmission && 
                            submission.assignmentSubmission.attachments && 
                            submission.assignmentSubmission.attachments.length > 0) {
                            
                            attachmentLinks = submission.assignmentSubmission.attachments.map(attachment => {
                                if (attachment.driveFile) {
                                    return `<a href="${attachment.driveFile.alternateLink}" target="_blank">${attachment.driveFile.title}</a>`;
                                } else if (attachment.link) {
                                    return `<a href="${attachment.link.url}" target="_blank">${attachment.link.title || 'Link'}</a>`;
                                } else {
                                    return 'Unknown attachment type';
                                }
                            }).join('<br>');
                        }
                        
                        submissionsHtml += `
                            <tr>
                                <td>${studentName}</td>
                                <td>${submission.state || 'Unknown'}</td>
                                <td>${submission.assignedGrade || 'Not graded'}</td>
                                <td>${submissionTime}</td>
                                <td>${attachmentLinks}</td>
                            </tr>
                        `;
                    }
                    
                    submissionsHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('submissions-content').innerHTML = submissionsHtml;
                }
                
                showMessage(`Successfully loaded ${submissions.length} submissions`);
            } catch (error) {
                console.error("Error fetching submissions:", error);
                let errorMsg = "Error fetching submissions: ";
                
                if (error.result) {
                    errorMsg += error.result.error.message || JSON.stringify(error.result);
                } else if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += JSON.stringify(error);
                }
                
                document.getElementById('submissions-content').innerHTML = `<p class="error">${errorMsg}</p>`;
                showMessage(errorMsg, true);
            } finally {
                setLoading(false);
            }
        }
        
        // Update selected class in sidebar
        function updateSelectedClass(classId) {
            // Remove selected class from all items
            const classItems = document.querySelectorAll('.class-item');
            classItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to current item
            const currentItem = document.querySelector(`.class-item[data-id="${classId}"]`);
            if (currentItem) {
                currentItem.classList.add('selected');
            }
        }
        
        // Hide all content cards
        function hideAllCards() {
            welcomeCard.style.display = 'none';
            classDetailCard.style.display = 'none';
            studentsCard.style.display = 'none';
            assignmentsCard.style.display = 'none';
            submissionsCard.style.display = 'none';
        }
    </script>
</body>
</html>